# Kidney_Tissue_Segmentation

**1. Clone repository**
  - git clone https://github.com/Khangxlei/Kidney_Tissue_Segmentation/

**2. Ensure data files**
  - Place the source and target data files in the correct directory within the project.

**3. Preprocessing (preprocess.py)**
  - _Description_: This file processes all the data within the given directory (the directory should hold both images and labels with the same filename associated to each other), and embeds all of them into a compressed numpy (.npz) file for data loading later on.
  - Run preprocess.py twice, each time changing its parameters to process different datasets.

**4. Train Bounding Box Model (get_bbox_model.ipynb)**
  - _Description_: This file initialize the Faster R-CNN model through Pytorch, and train it on all the MedSAM data as well as 80% of our kidney tissue image dataset with 5-fold cross validation. 
  - Open and run get_bbox_model.ipynb in Jupyter Notebook. Execute all cells.

**5. Train MedSAM Model (finetune_and_inference_tutorial_2D_dataset.ipynb)**
  - _Description_: This file is given to us through MedSAM, which trains the model on 2D images. The file has been trained on the MedSAM data, as well as our own kidney tissue dataset.
  - Open and run finetune_and_inference_tutorial_2D_dataset.ipynb in Jupyter Notebook. Execute all cells.

**6. Inference Data (inference.py) 
  - _Description_: The inference.py file simply takes in both the checkpoint (.pth) file that have the trained weights generated by the Faster R-CNN and MedSAM model. It first loads the weights from the Faster R-CNN model to propose a bounding box, it then gives the bounding box into the prompt encoder for the MedSAM model to make its cortex prediction.
  - Run inference.py to perform inference on the testing dataset using the trained model.


**7. Evaluation (IoU.py + DSC.py)**
  - _Description_: The IoU.py and DSC.py files simply takes the segmented image generated by the MedSAM model, and it compares them with the annotated ground truths to calculate the IoU and DSC metric for our results collection. 
  - Run IoU.py to calculate the Intersection over Union (IoU) scores for the testing dataset and record the values into an Excel spreadsheet.
  - Run DSC.py to calculate the Dice Similarity Coefficient (DSC) scores for the testing dataset and record the values into an Excel spreadsheet.
    
**Results**
  - The Excel spreadsheets in the results folder contain the IoU scores calculated using 5-fold cross-validation across 100 annotated kidney tissue images.
  - There are four files:
      - '_DSC with RCNN UPDATED.xlsx_': DSC results with Faster R-CNN trained over the MedSAM and kidney tissue datasets. 
      - '_IoU with RCNN UPDATED.xlsx_': IoU results with Faster R-CNN trained over the MedSAM and kidney tissue datasets.
      - '_IoU with RCNN and DANN.xlsx_': IoU results with Faster R-CNN as well as DANN.
      - '_IoU with RCNN without DANN.xlsx_': IoU results with Faster R-CNN and without DANN. 
